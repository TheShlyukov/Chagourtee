# Chagourtee

Самохостируемый мессенджер: владелец запускает сервер на своём компьютере, создаёт инвайты и верифицирует участников по кодовому слову. В перспективе — федерация между серверами.

## Стек

- **Сервер:** Node.js, Fastify, SQLite (better-sqlite3), WebSocket (ws)
- **Клиент:** React, TypeScript, Vite

## Быстрый старт

### 1. Установка

```bash
npm install
```

### 2. Запуск в режиме разработки

В двух терминалах:

```bash
# Сервер (порт 3000)
npm run dev:server

# Клиент (порт 5173, проксирует /api и /ws на сервер)
npm run dev:client
```

Или одной командой:

```bash
npm run dev
```

Откройте http://localhost:5173

**Доступ с телефона или другого устройства в той же Wi‑Fi:** откройте в браузере `http://ИМЯ_ИЛИ_IP_ВАШЕГО_КОМПЬЮТЕРА:5173` (например, `http://macbook-air-dana.local:5173`). Чтобы ссылки-инвайты вели на этот адрес (а не на localhost), создайте в корне проекта или в `client/` файл `.env` и добавьте строку:
```bash
VITE_APP_PUBLIC_URL=http://<ВАШ_IP_АДРЕСС>:5173
```
После изменения перезапустите клиент (`npm run dev:client`).

### 3. Первый владелец

Если в базе ещё нет пользователей, первого владельца можно создать так:

1. Установите переменную окружения (или добавьте в `server/config.example.env` и переименуйте в `.env`):
   ```bash
   export CHAGOURTEE_BOOTSTRAP_SECRET=ваш-секретный-ключ
   ```
2. На странице регистрации (/register) передайте в запросе (через devtools или отдельную форму) параметр `bootstrap` со значением этого секрета вместе с логином и паролем. Либо вызовите API:
   ```bash
   curl -X POST http://localhost:3000/api/auth/register \
     -H "Content-Type: application/json" \
     -d '{"login":"admin","password":"ваш-пароль","bootstrap":"ваш-секретный-ключ"}'
   ```
3. После этого входите под созданным логином — вы владелец. Создайте инвайты в Админке и при необходимости комнаты.

### 4. Участники

- Владелец (или модератор) создаёт инвайт в Админке и передаёт ссылку вида:  
  `https://ваш-адрес/register?invite=КОД_ИНВАЙТА`
- Участник переходит по ссылке, вводит логин, пароль и при необходимости кодовое слово.
- Если указано кодовое слово, аккаунт остаётся в статусе «ожидает верификации» до тех пор, пока владелец в Админке не проверит слово и не нажмёт «Подтвердить».

## Деплой у владельца

### Продакшен-сборка

```bash
npm run build
```

Собранный клиент окажется в `client/dist`. Раздавайте его через любой HTTP-сервер (Nginx, Caddy и т.п.), указав корнем каталог `client/dist` и проксирование `/api` и `/ws` на процесс сервера.

### Запуск сервера

```bash
cd server
PORT=3000 node src/index.js
```

Рекомендуется задать переменные окружения (или файл `.env` в `server/`):

- `PORT` — порт (по умолчанию 3000)
- `HOST` — хост (0.0.0.0 для доступа с других машин)
- `CHAGOURTEE_DB_PATH` — путь к файлу SQLite (по умолчанию `./data/chagourtee.db`)
- `CHAGOURTEE_SESSION_SECRET` — секрет для cookie (обязательно смените)
- `CHAGOURTEE_BOOTSTRAP_SECRET` — секрет для создания первого владельца (см. выше)

### Доступ из интернета

Сервер за NAT/домашним роутером недоступен по внешнему IP без проброса портов. Варианты:

- **Проброс портов** на роутере на машину с сервером.
- **Tailscale / ZeroTier** — участники подключаются по выданному адресу в VPN.
- **Cloudflare Tunnel** — туннель с вашей машины в интернет по домену.

Клиент должен открываться по тому же origin, что и API (или настроен CORS и cookie с правильным domain).

### Резервное копирование БД

```bash
npm run db:backup
```

Копия SQLite сохраняется в `data/backups/` (или рядом с `CHAGOURTEE_DB_PATH` в подкаталоге `backups`).

## API (кратко)

- `POST /api/auth/login` — вход
- `POST /api/auth/logout` — выход
- `GET /api/auth/me` — текущий пользователь
- `POST /api/auth/register` — регистрация (inviteId или bootstrap)
- `GET/POST/PATCH/DELETE /api/rooms` — комнаты (CRUD для владельца/модератора)
- `GET /api/rooms/:id/messages`, `POST /api/rooms/:id/messages` — сообщения
- `GET/POST/DELETE /api/invites` — инвайты
- `GET /api/verification/pending`, `POST /api/verification/check`, `approve`, `reject` — верификация по кодовому слову
- `POST /api/profile/change-password`, `change-login`, `codeword` — профиль
- WebSocket `/ws` — новые сообщения, типинг, присутствие (после входа по cookie)

## Лицензия

MIT
